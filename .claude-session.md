# Claude Session Context - PureGopherAI Setup

## Session Date: 2026-01-02

## What We Did

### Session 1 (Earlier)
1. **Verified machine**: M1 Ultra confirmed, but running under Rosetta (x86 mode)
2. **Diagnosed architecture issue**: Node.js at `/usr/local/bin/node` was x86, causing Claude Code and all child processes to run in Rosetta
3. **Fixed Torchx compilation failure**: PyTorch libtorch macOS downloads return 403 errors
4. **Switched backend from Torchx to EXLA**: Temporary workaround
5. **Successfully compiled and tested**: Server started on port 7070

### Session 2 (Current - ARM Mode)
1. **Verified ARM mode**: Switched to ARM Node.js and Elixir via Homebrew
2. **Re-enabled Torchx**: Using ARM64 libtorch nightly build
3. **Fixed cmake architecture**: Installed ARM cmake via Homebrew (x86 cmake was causing x86 builds)
4. **Installed libomp**: Required dependency for libtorch
5. **Successfully built and tested**: Torchx now works with Metal MPS backend

## Current Configuration

### Environment Variables (added to ~/.zshrc)
```bash
# ARM Homebrew and Torchx
export PATH="/opt/homebrew/bin:$PATH"
export LIBTORCH_DIR=~/libtorch/libtorch
```

### Files Modified

#### `config/config.exs` (lines 7-17)
Torchx with Metal MPS for macOS:
```elixir
nx_backend =
  case :os.type() do
    {:unix, :darwin} ->
      # Apple Silicon - Torchx with Metal MPS GPU acceleration
      # Requires: export LIBTORCH_DIR=~/libtorch/libtorch
      {Torchx.Backend, device: :mps}

    _ ->
      # CPU fallback via EXLA
      {EXLA.Backend, []}
  end
```

#### `mix.exs` (line 38)
Torchx re-enabled:
```elixir
{:torchx, "~> 0.9"},  # Re-enabled with manual libtorch download
```

## Architecture Verification

| Component | Path | Architecture |
|-----------|------|--------------|
| Node.js | `/opt/homebrew/bin/node` | arm64 |
| Elixir | `/opt/homebrew/bin/elixir` | arm64 (OTP 28) |
| CMake | `/opt/homebrew/bin/cmake` | arm64 |
| libomp | `/opt/homebrew/opt/libomp/lib/libomp.dylib` | arm64 |
| libtorch | `~/libtorch/libtorch/lib/libtorch.dylib` | arm64 |
| torchx.so | `_build/dev/lib/torchx/priv/torchx.so` | arm64 |

## Current State

- **Project compiles**: Yes
- **Server runs**: Yes, on port 7070 (clearnet) and 7071 (Tor)
- **AI model loads**: Yes, using Torchx backend with Metal MPS
- **Backend**: `{Torchx.Backend, [device: :mps]}`

## Commands to Run

```bash
# Start development server
cd /Users/anthonyramirez/pure_gopher_ai
iex -S mix

# Or production mode
MIX_ENV=prod mix run --no-halt

# Test connection
echo "" | nc localhost 7070

# Verify ARM mode
uname -m        # Should show: arm64
arch            # Should show: arm64
```

## Dependencies Installed via Homebrew (ARM)

- `node` - ARM64 Node.js
- `elixir` - ARM64 Elixir + Erlang/OTP 28
- `cmake` - ARM64 CMake (required for Torchx native compilation)
- `libomp` - OpenMP library (required by libtorch)

## Pre-existing Warnings (Not addressed)

- `Notifications.create/5` undefined in comments.ex, follows.ex
- `GopherProxy.fetch/3` undefined in federation.ex
- Unused variable in related_content.ex
- Deprecated charlist syntax in webhooks.ex

## Troubleshooting

### If Torchx fails to load
1. Verify `LIBTORCH_DIR` is set: `echo $LIBTORCH_DIR`
2. Verify libomp exists: `ls /opt/homebrew/opt/libomp/lib/libomp.dylib`
3. Verify ARM cmake is first in PATH: `which cmake` should show `/opt/homebrew/bin/cmake`

### If build produces x86 binaries
1. Check PATH order - `/opt/homebrew/bin` must come before `/usr/local/bin`
2. Clean and rebuild: `rm -rf _build deps && mix deps.get && mix compile`
